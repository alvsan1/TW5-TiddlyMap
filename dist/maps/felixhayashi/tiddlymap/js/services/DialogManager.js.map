{"version":3,"sources":["felixhayashi/tiddlymap/js/services/DialogManager.js"],"names":["DialogManager","callbackManager","context","templateId","param","callback","isTrue","$tm","config","sys","suppressedDialogs","logger","bind","dialogTRef","path","tempRoot","genUUID","skeleton","getTiddler","dialogs","dialog","title","buttons","fields","classes","output","result","temp","template","currentTiddler","text","getText","preselects","$tw","wiki","addTiddler","Tiddler","flatten","merge","footer","footers","fn","getElement","click","triggerTObj","tRef","isConfirmed","outputTObj","notify","deleteByPrefix","add","dialogTiddler","rootWidget","dispatchEvent","type","paramObject","addKeyBindings","name","getFirstElementByClassName","keys","keycharm","container","re","triggers","document","getElementsByClassName","i","length","classNames","className","split","j","matches","match","buttonName","key","buttonElement"],"mappings":";;;;;;qjBAAA;AACA;;;;;;;;;;AAUA;;;;AACA;;;;;;;;AAEA;;;;IAIMA,a;;AAEJ;;;;;;;;AAQA,yBAAYC,eAAZ,EAA6BC,OAA7B,EAAsC;AAAA;;AAEpC;AACA,SAAKD,eAAL,GAAuBA,eAAvB;AACA,SAAKC,OAAL,GAAeA,OAAf;AAED;;AAED;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;yBAkCKC,U,EAAkC;AAAA,UAAtBC,KAAsB,uEAAd,EAAc;AAAA,UAAVC,QAAU;;;AAErC,UAAI,gBAAMC,MAAN,CAAaC,IAAIC,MAAJ,CAAWC,GAAX,CAAeC,iBAAf,CAAiCP,UAAjC,CAAb,EAA2D,KAA3D,CAAJ,EAAuE;AACrEI,YAAII,MAAJ,CAAW,SAAX,EAAsB,mBAAtB,EAA2CR,UAA3C;AACA;AACD;;AAEDI,UAAII,MAAJ,CAAW,OAAX,EAAoB,qBAApB,EAA2CP,KAA3C;;AAEA,UAAI,OAAOC,QAAP,KAAoB,UAApB,IAAkC,KAAKH,OAA3C,EAAoD;AAClDG,mBAAWA,SAASO,IAAT,CAAc,KAAKV,OAAnB,CAAX;AACD;;AAED;AACA,UAAMW,aAAgBN,IAAIO,IAAJ,CAASC,QAAzB,gBAA4C,gBAAMC,OAAN,EAAlD;;AAEA;AACA,UAAMC,WAAW,gBAAMC,UAAN,CAAoBX,IAAIO,IAAJ,CAASK,OAA7B,SAAwChB,UAAxC,CAAjB;;AAEA;AACA,UAAIiB,SAAS;AACXC,eAAOR,UADI;AAEXS,iBAASL,SAASM,MAAT,CAAgB,SAAhB,KAA8B,WAF5B;AAGXC,iBAAS,wBAAwBP,SAASM,MAAT,CAAgB,SAAhB,CAHtB;AAIXE,gBAAQZ,aAAa,SAJV;AAKXa,gBAAQb,aAAa,SALV;AAMXc,cAAMd,aAAa,OANR;AAOXe,kBAAUX,SAASM,MAAT,CAAgBF,KAPf;AAQXlB,oBAAYA,UARD;AASX0B,wBAAgBhB,aAAa,SATlB;AAUXiB,cAAM,gBAAMC,OAAN,CAAcxB,IAAIO,IAAJ,CAASK,OAAvB;AAVK,OAAb;;AAaA,UAAIf,MAAMgB,MAAV,EAAkB;;AAEhB,YAAIhB,MAAMgB,MAAN,CAAaY,UAAjB,EAA6B;;AAE3B;AACAC,cAAIC,IAAJ,CAASC,UAAT,CAAoB,IAAIF,IAAIG,OAAR,CAClB,EAACf,OAAOD,OAAOK,MAAf,EADkB,EAElB,gBAAMY,OAAN,CAAcjC,MAAMgB,MAAN,CAAaY,UAA3B,CAFkB,CAApB;;AAKA;AACA,iBAAO5B,MAAMgB,MAAN,CAAaY,UAApB;AAED;;AAED;AACA,wBAAMM,KAAN,CAAYlB,MAAZ,EAAoBhB,MAAMgB,MAA1B;AAED;;AAED;AACA;AACA;AACAA,aAAOmB,MAAP,GAAgB,gBAAMR,OAAN,CAAcxB,IAAIO,IAAJ,CAAS0B,OAAvB,CAAhB;;AAEA;AACApB,eAAS,gBAAMiB,OAAN,CAAcjB,MAAd,CAAT;AACAhB,cAAQ,gBAAMiC,OAAN,CAAcjC,KAAd,CAAR;;AAEA,UAAMqC,KAAK,SAALA,EAAK,OAAQ;;AAEjBzC,sBAAc0C,UAAd,CAAyB,qBAAzB,EAAgDC,KAAhD;;AAEA,YAAMC,cAAcX,IAAIC,IAAJ,CAAShB,UAAT,CAAoB2B,IAApB,CAApB;AACA,YAAMC,cAAcF,YAAYrB,MAAZ,CAAmBO,IAAvC;;AAEA,YAAIiB,aAAa,IAAjB;AACA,YAAID,WAAJ,EAAiB;AACfC,uBAAad,IAAIC,IAAJ,CAAShB,UAAT,CAAoBE,OAAOK,MAA3B,CAAb;AACD,SAFD,MAEO;AACLlB,cAAIyC,MAAJ,CAAW,qBAAX;AACD;;AAED,YAAI,OAAO3C,QAAP,KAAoB,UAAxB,EAAoC;AAClCA,mBAASyC,WAAT,EAAsBC,UAAtB;AACD;;AAED;AACA,wBAAME,cAAN,CAAqBpC,UAArB;AAED,OArBD;;AAuBA;AACA,WAAKZ,eAAL,CAAqBiD,GAArB,CAAyB9B,OAAOM,MAAhC,EAAwCe,EAAxC,EAA4C,IAA5C;;AAGA;AACA,UAAMU,gBAAgB,IAAIlB,IAAIG,OAAR,CAAgBnB,QAAhB,EAA0Bb,KAA1B,EAAiCgB,MAAjC,CAAtB;AACAa,UAAIC,IAAJ,CAASC,UAAT,CAAoBgB,aAApB;;AAEA5C,UAAII,MAAJ,CAAW,OAAX,EAAoB,gBAApB,EAAsCwC,aAAtC;;AAEAlB,UAAImB,UAAJ,CAAeC,aAAf,CAA6B;AAC3BC,cAAM,UADqB;AAE3BlD,eAAO+C,cAAc5B,MAAd,CAAqBF,KAFD;AAG3BkC,qBAAaJ,cAAc5B;AAHA,OAA7B;;AAMAvB,oBAAcwD,cAAd;;AAEA,aAAOL,aAAP;AAED;;;+BAEiBM,I,EAAM;;AAEtB,aAAO,gBAAMC,0BAAN,CAAiC,UAAUD,IAA3C,CAAP;AAED;;AAED;;;;;;;;;;qCAOwB;;AAEtB,UAAME,OAAOpD,IAAIqD,QAAJ,CAAa;AACxBC,mBAAW,gBAAMH,0BAAN,CAAiC,UAAjC;AADa,OAAb,CAAb;;AAIA,UAAMI,KAAK,sCAAX;AACA,UAAMC,WAAWC,SAASC,sBAAT,CAAgC,oBAAhC,CAAjB;;AAEA,WAAK,IAAIC,IAAIH,SAASI,MAAtB,EAA8BD,GAA9B,GAAoC;AAClC,YAAME,aAAaL,SAASG,CAAT,EAAYG,SAAZ,CAAsBC,KAAtB,CAA4B,GAA5B,CAAnB;AACA,aAAK,IAAIC,IAAIH,WAAWD,MAAxB,EAAgCI,GAAhC,GAAsC;AACpC,cAAMC,UAAUJ,WAAWG,CAAX,EAAcE,KAAd,CAAoBX,EAApB,CAAhB;AACA,cAAI,CAACU,OAAL,EAAc;AAAE;AACd;AACD;AACD,cAAME,aAAaF,QAAQ,CAAR,CAAnB;AACA,cAAMG,MAAMH,QAAQ,CAAR,CAAZ;AACA,cAAMI,gBAAgB5E,cAAc0C,UAAd,CAAyBgC,UAAzB,CAAtB;AACA,cAAI,CAACE,aAAL,EAAoB;AACpBjB,eAAK/C,IAAL,CAAU+D,GAAV,EAAe,YAAY;AACzB,iBAAKhC,KAAL;AACD,WAFc,CAEb/B,IAFa,CAERgE,aAFQ,CAAf;AAGD;AACF;AAEF;;;;;;AAGH;;kBAEe5E,a","file":"../../../../../felixhayashi/tiddlymap/js/services/DialogManager.js","sourcesContent":["// @preserve\n/*\\\n\ntitle: $:/plugins/felixhayashi/tiddlymap/js/DialogManager\ntype: application/javascript\nmodule-type: library\n\n@preserve\n\n\\*/\n\nimport utils           from '$:/plugins/felixhayashi/tiddlymap/js/utils';\nimport CallbackManager from '$:/plugins/felixhayashi/tiddlymap/js/CallbackManager';\n\n/**\n * The DialogManager is responsible for preparing, displaying and\n * finalizing all the dialogs.\n */\nclass DialogManager {\n\n  /**\n   * @param {CallbackManager} callbackManager - A callback manager that\n   *     is informed about changed tiddlers and keeps track of the\n   *     various tiddlers produced during the dialog process.\n   * @param {Object} [context] - An optional *this*-reference to bind the\n   *     callback of each called dialog to. Otherwise, the callback of\n   *     each dialog has to be bound manually to the callback if required.\n   */\n  constructor(callbackManager, context) {\n\n    // create callback registry\n    this.callbackManager = callbackManager;\n    this.context = context;\n\n  }\n\n  /**\n   * This function opens a dialog based on a skeleton and some fields and eventually\n   * calls a callback once the dialog is closed. The callback contains an indicator\n   * whether the dialog subject was confirmed or the operation cancelled. In any\n   * case the output tiddler is passed to the callback. Each dialog may write its\n   * changes to this tiddler in order to store the dialog result and make it available\n   * to the callback.\n   *\n   * How does it work?\n   *\n   * The output of the dialog process is stored in a temporary tiddler that is only known\n   * to the current instance of the dialog. This way it is ensured that only the dialog process\n   * that created the temporary tiddler will retrieve the result. Now we are able to\n   * provide unambigous and unique correspondance to dialog callbacks.\n\n   * Any dialog output is stored in a unique output-tiddler. Once there is a result,\n   * a new result tiddler is created with indicators how to interpret the output.\n   * The result tiddler can be understood as exit code that is independent of the output.\n   * It is the result tiddler that triggers the dialog callback that was registered before.\n   * the output is then read immediately from the output-tiddler.\n   *\n   * @param {string} templateId - The dialog id which is the basename of\n   *     the template title.\n   * @param {Hashmap} [param] - All properties (except those with special meanings)\n   *     of param will be accessible as variables in the modal\n   * @param {string} [param.subtitle] -\n   * @param {string} [param.cancelButtonLabel] - The label of the cancel button.\n   * @param {string} [param.confirmButtonLabel] - The label of the confirm button.\n   * @param {function} [callback] - A function with the signature\n   *     function(isConfirmed, outputTObj). `outputTObj` contains data\n   *     produced by the dialog (can be undefined even if confirmed!).\n   *     Be careful: the tiddler that outputTObj represents is deleted immediately.\n   * @return {$tw.Tiddler} The dialog tddler object with all its fields.\n   */\n  open(templateId, param = {}, callback) {\n\n    if (utils.isTrue($tm.config.sys.suppressedDialogs[templateId], false)) {\n      $tm.logger('warning', 'Suppressed dialog', templateId);\n      return;\n    }\n\n    $tm.logger('debug', 'Dialog param object', param);\n\n    if (typeof callback === 'function' && this.context) {\n      callback = callback.bind(this.context);\n    }\n\n    // create a temporary tiddler reference for the dialog\n    const dialogTRef = `${$tm.path.tempRoot}/dialog-${utils.genUUID()}`;\n\n    // get the dialog template\n    const skeleton = utils.getTiddler(`${$tm.path.dialogs}/${templateId}`);\n\n    // fields used to handle the dialog process\n    let dialog = {\n      title: dialogTRef,\n      buttons: skeleton.fields['buttons'] || 'ok_cancel',\n      classes: 'tmap-modal-content ' + skeleton.fields['classes'],\n      output: dialogTRef + '/output',\n      result: dialogTRef + '/result',\n      temp: dialogTRef + '/temp',\n      template: skeleton.fields.title,\n      templateId: templateId,\n      currentTiddler: dialogTRef + '/output',\n      text: utils.getText($tm.path.dialogs)\n    };\n\n    if (param.dialog) {\n\n      if (param.dialog.preselects) {\n\n        // register preselects\n        $tw.wiki.addTiddler(new $tw.Tiddler(\n          {title: dialog.output},\n          utils.flatten(param.dialog.preselects)\n        ));\n\n        // remove preselects from param object\n        delete param.dialog.preselects;\n\n      }\n\n      // extend the dialog object with parameters provided by the user\n      utils.merge(dialog, param.dialog);\n\n    }\n\n    // force the footer to be set to the wrapper\n    // the footer wrapper will determine the footer from the\n    // buttons field/variable\n    dialog.footer = utils.getText($tm.path.footers);\n\n    // flatten dialog and param object\n    dialog = utils.flatten(dialog);\n    param = utils.flatten(param);\n\n    const fn = tRef => {\n\n      DialogManager.getElement('hidden-close-button').click();\n\n      const triggerTObj = $tw.wiki.getTiddler(tRef);\n      const isConfirmed = triggerTObj.fields.text;\n\n      let outputTObj = null;\n      if (isConfirmed) {\n        outputTObj = $tw.wiki.getTiddler(dialog.output);\n      } else {\n        $tm.notify('operation cancelled');\n      }\n\n      if (typeof callback === 'function') {\n        callback(isConfirmed, outputTObj);\n      }\n\n      // close and remove all tiddlers used by the dialog\n      utils.deleteByPrefix(dialogTRef);\n\n    };\n\n    // add trigger\n    this.callbackManager.add(dialog.result, fn, true);\n\n\n    // create dialog\n    const dialogTiddler = new $tw.Tiddler(skeleton, param, dialog);\n    $tw.wiki.addTiddler(dialogTiddler);\n\n    $tm.logger('debug', 'Opening dialog', dialogTiddler);\n\n    $tw.rootWidget.dispatchEvent({\n      type: 'tm-modal',\n      param: dialogTiddler.fields.title,\n      paramObject: dialogTiddler.fields\n    });\n\n    DialogManager.addKeyBindings();\n\n    return dialogTiddler;\n\n  };\n\n  static getElement(name) {\n\n    return utils.getFirstElementByClassName('tmap-' + name);\n\n  }\n\n  /**\n   * This method will search for form elements that have the class\n   * `tmap-trigger-field` set, which means that TiddlyMap shall\n   * perform a button press when a key combo occurs while the field\n   * has focus. To know which button to press on what key event,\n   * it looks for classes of the form: tmap-triggers-BUTTONNAME-on-KEYCOMBO.\n   */\n  static addKeyBindings() {\n\n    const keys = $tm.keycharm({\n      container: utils.getFirstElementByClassName('tc-modal')\n    });\n\n    const re = /tmap-triggers-(.+?)-on-(.+?)(?:\\s|$)/;\n    const triggers = document.getElementsByClassName('tmap-trigger-field');\n\n    for (let i = triggers.length; i--;) {\n      const classNames = triggers[i].className.split(' ');\n      for (let j = classNames.length; j--;) {\n        const matches = classNames[j].match(re);\n        if (!matches) { // don't care\n          continue;\n        }\n        const buttonName = matches[1];\n        const key = matches[2];\n        const buttonElement = DialogManager.getElement(buttonName);\n        if (!buttonElement) continue;\n        keys.bind(key, function () {\n          this.click();\n        }.bind(buttonElement));\n      }\n    }\n\n  }\n}\n\n/*** Exports *******************************************************/\n\nexport default DialogManager;\n"],"sourceRoot":"../../../../../../src/plugins"}